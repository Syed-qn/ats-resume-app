{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <meta name="description" content="Create ATS-optimized resumes that get you interviews. Beat the applicant tracking system with our AI-powered tool.">
  <title>ATS Resume Optimizer - Beat the ATS System</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Poppins:wght@600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- Icons & Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* CSS Reset & Base */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    /* Design Tokens */
    :root {
      /* Colors - Ocean Professional */
      --primary: #0066cc;
      --primary-light: #0080ff;
      --primary-dark: #004c99;
      --accent: #00d4aa;
      --accent-dark: #00a88a;
      --gold: #ffb800;
      --gold-dark: #e6a600;
      --dark: #001f3f;
      --dark-light: #003366;
      --gray-100: #f8fafc;
      --gray-200: #e9ecef;
      --gray-300: #dee2e6;
      --gray-400: #ced4da;
      --gray-500: #adb5bd;
      --gray-600: #6c757d;
      --gray-700: #495057;
      --gray-800: #343a40;
      --gray-900: #212529;
      --white: #ffffff;
      --black: #000000;
      
      /* Typography Scale */
      --fs-xs: clamp(0.75rem, 0.7rem + 0.25vw, 0.875rem);
      --fs-sm: clamp(0.875rem, 0.8rem + 0.375vw, 1rem);
      --fs-base: clamp(1rem, 0.925rem + 0.375vw, 1.125rem);
      --fs-lg: clamp(1.125rem, 1rem + 0.625vw, 1.25rem);
      --fs-xl: clamp(1.25rem, 1.1rem + 0.75vw, 1.5rem);
      --fs-2xl: clamp(1.5rem, 1.25rem + 1.25vw, 2rem);
      --fs-3xl: clamp(1.875rem, 1.5rem + 1.875vw, 2.5rem);
      --fs-4xl: clamp(2.25rem, 1.75rem + 2.5vw, 3rem);
      --fs-5xl: clamp(3rem, 2rem + 5vw, 4rem);
      
      /* Spacing Scale */
      --space-xs: clamp(0.25rem, 0.2rem + 0.25vw, 0.5rem);
      --space-sm: clamp(0.5rem, 0.4rem + 0.5vw, 0.75rem);
      --space-md: clamp(1rem, 0.8rem + 1vw, 1.5rem);
      --space-lg: clamp(1.5rem, 1.2rem + 1.5vw, 2rem);
      --space-xl: clamp(2rem, 1.5rem + 2.5vw, 3rem);
      --space-2xl: clamp(3rem, 2rem + 5vw, 4rem);
      --space-3xl: clamp(4rem, 3rem + 5vw, 6rem);
      
      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
      --shadow-xl: 0 20px 25px rgba(0,0,0,0.1);
      --shadow-2xl: 0 25px 50px rgba(0,0,0,0.15);
      
      /* Border Radius */
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --radius-2xl: 1.5rem;
      --radius-full: 9999px;
      
      /* Z-index */
      --z-base: 0;
      --z-dropdown: 10;
      --z-sticky: 20;
      --z-fixed: 30;
      --z-modal-backdrop: 40;
      --z-modal: 50;
      --z-popover: 60;
      --z-tooltip: 70;
    }
    
    /* Base Styles */
    html {
      font-size: 16px;
      scroll-behavior: smooth;
      -webkit-text-size-adjust: 100%;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: var(--fs-base);
      line-height: 1.6;
      color: var(--gray-900);
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 50%, #f0fdf4 100%);
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Typography */
    h1, h2, h3, h4, h5, h6 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      line-height: 1.2;
      color: var(--gray-900);
    }
    
    /* Container */
    .container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 var(--space-md);
    }
    
    /* Navigation Placeholder */
    .nav-placeholder {
      height: 80px;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0,0,0,0.05);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: var(--z-fixed);
    }
    
    /* Main Content */
    .main-content {
      margin-top: 100px;
      padding-bottom: var(--space-3xl);
    }
    
    /* WhatsApp Button */
    .whatsapp-float {
      position: fixed;
      right: var(--space-lg);
      top: 50%;
      transform: translateY(-50%);
      width: clamp(3.5rem, 4vw, 4.5rem);
      height: clamp(3.5rem, 4vw, 4.5rem);
      background: #25D366;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-xl);
      z-index: var(--z-fixed);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: translateY(-50%) scale(1); }
      50% { transform: translateY(-50%) scale(1.05); }
    }
    
    .whatsapp-float:hover {
      transform: translateY(-50%) scale(1.1) rotate(5deg);
      box-shadow: 0 15px 35px rgba(37, 211, 102, 0.4);
    }
    
    .whatsapp-float i {
      color: var(--white);
      font-size: clamp(1.5rem, 2vw, 2rem);
    }
    
    /* Welcome Banner */
    .welcome-banner {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      padding: var(--space-xl) var(--space-xl);
      border-radius: var(--radius-2xl);
      margin-bottom: var(--space-xl);
      text-align: center;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }
    
    .welcome-banner::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="white" opacity="0.1"/></svg>') repeat;
      animation: float 20s infinite linear;
    }
    
    @keyframes float {
      0% { transform: translateY(0px); }
      100% { transform: translateY(-100px); }
    }
    
    .welcome-content {
      position: relative;
      z-index: 2;
    }
    
    .welcome-banner h2 {
      font-size: var(--fs-3xl);
      margin-bottom: var(--space-sm);
    }
    
    .welcome-banner p {
      font-size: var(--fs-lg);
      opacity: 0.9;
      margin-bottom: var(--space-lg);
    }
    
    .quick-actions {
      display: flex;
      justify-content: center;
      gap: var(--space-md);
      flex-wrap: wrap;
    }
    
    .quick-action-btn {
      background: rgba(255, 255, 255, 0.2);
      color: var(--white);
      border: 2px solid rgba(255, 255, 255, 0.3);
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-lg);
      text-decoration: none;
      font-weight: 600;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      backdrop-filter: blur(10px);
    }
    
    .quick-action-btn:hover {
      background: var(--white);
      color: var(--primary);
      transform: translateY(-2px);
    }
    
    /* Header */
    .header {
      text-align: center;
      margin-bottom: var(--space-2xl);
    }
    
    .header h1 {
      font-size: var(--fs-4xl);
      margin-bottom: var(--space-sm);
      color: var(--gray-900);
    }
    
    .header p {
      font-size: var(--fs-lg);
      color: var(--gray-600);
    }
    
    /* Main Content Card */
    .main-content-card {
      background: var(--white);
      border-radius: var(--radius-2xl);
      padding: var(--space-2xl);
      box-shadow: var(--shadow-2xl);
      position: relative;
      overflow: hidden;
    }
    
    .main-content-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 50%, var(--gold) 100%);
    }
    
    /* Premium Banner for each step */
    .step-premium-banner {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      border: 2px solid var(--gold);
      border-radius: var(--radius-xl);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
      display: flex;
      align-items: center;
      gap: var(--space-lg);
      position: relative;
      overflow: hidden;
    }
    
    .step-premium-banner::after {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(255, 184, 0, 0.1) 0%, transparent 70%);
    }
    
    .premium-banner-icon {
      font-size: var(--fs-3xl);
      color: var(--gold-dark);
      flex-shrink: 0;
    }
    
    .premium-banner-content h3 {
      font-size: var(--fs-xl);
      margin-bottom: var(--space-xs);
      color: var(--gray-900);
    }
    
    .premium-banner-content p {
      color: var(--gray-700);
      margin-bottom: var(--space-sm);
    }
    
    .premium-banner-timer {
      background: rgba(255, 59, 48, 0.1);
      color: #ff3b30;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--radius-full);
      font-size: var(--fs-sm);
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .btn-premium {
      background: linear-gradient(135deg, var(--gold) 0%, var(--gold-dark) 100%);
      color: var(--dark);
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-lg);
      text-decoration: none;
      font-weight: 700;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      transition: all 0.3s ease;
      margin-top: var(--space-sm);
    }
    
    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(255, 184, 0, 0.4);
    }
    
    /* Step Indicator */
    .step-indicator {
      display: flex;
      justify-content: center;
      margin-bottom: var(--space-2xl);
      gap: var(--space-xs);
    }
    
    .step-dot {
      width: 3rem;
      height: 3rem;
      border-radius: var(--radius-full);
      background: var(--gray-200);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
      color: var(--gray-600);
      font-weight: 600;
    }
    
    .step-dot.active {
      background: var(--primary);
      color: var(--white);
      transform: scale(1.1);
    }
    
    .step-dot.completed {
      background: var(--accent);
      color: var(--white);
    }
    
    .step-dot::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 100%;
      width: 30px;
      height: 2px;
      background: var(--gray-300);
      transform: translateY(-50%);
    }
    
    .step-dot:last-child::after {
      display: none;
    }
    
    .step-dot.completed::after {
      background: var(--accent);
    }
    
    /* Steps */
    .step {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    
    .step.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .step-header {
      display: flex;
      align-items: center;
      margin-bottom: var(--space-xl);
      padding-bottom: var(--space-lg);
      border-bottom: 2px solid var(--gray-200);
    }
    
    .step-number {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: var(--white);
      width: 3.5rem;
      height: 3.5rem;
      border-radius: var(--radius-full);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--fs-xl);
      font-weight: 700;
      margin-right: var(--space-lg);
      box-shadow: var(--shadow-lg);
    }
    
    .step-title {
      font-size: var(--fs-2xl);
      color: var(--gray-900);
    }
    
    /* Upload Area */
    .entry-options {
      display: grid;
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    
    @media (min-width: 768px) {
      .entry-options {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .entry-option {
      height: 100%;
    }
    
    .upload-area {
      border: 3px dashed var(--primary);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      text-align: center;
      background: var(--gray-100);
      transition: all 0.3s ease;
      cursor: pointer;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .upload-area:hover {
      border-color: var(--primary-dark);
      background: var(--gray-200);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .upload-area.dragover {
      border-color: var(--accent);
      background: rgba(0, 212, 170, 0.1);
    }
    
    .upload-icon {
      font-size: var(--fs-5xl);
      color: var(--primary);
      margin-bottom: var(--space-lg);
    }
    
    .upload-text {
      font-size: var(--fs-lg);
      color: var(--gray-900);
      margin-bottom: var(--space-sm);
      font-weight: 600;
    }
    
    .file-input {
      display: none;
    }
    
    .manual-entry-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-2xl);
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
      background: var(--white);
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .manual-entry-card:hover {
      border-color: var(--primary);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .manual-entry-icon {
      font-size: var(--fs-5xl);
      color: var(--primary);
      margin-bottom: var(--space-lg);
    }
    
    .manual-entry-title {
      font-size: var(--fs-xl);
      font-weight: 700;
      margin-bottom: var(--space-sm);
      color: var(--gray-900);
    }
    
    .manual-entry-description {
      color: var(--gray-600);
      line-height: 1.6;
    }
    
    /* Resume List */
    .resume-list-header {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin: var(--space-xl) 0 var(--space-lg);
    }
    
    .resume-list-header h3 {
      font-size: var(--fs-xl);
      color: var(--gray-900);
      margin: 0;
    }
    
    .resume-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      margin-bottom: var(--space-md);
      background: var(--white);
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .resume-item:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .resume-item.selected {
      border-color: var(--accent);
      background: rgba(0, 212, 170, 0.05);
      box-shadow: var(--shadow-lg);
    }
    
    .resume-item-left {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      flex: 1;
    }
    
    .file-icon {
      font-size: var(--fs-2xl);
      color: var(--primary);
    }
    
    .resume-item-info {
      flex: 1;
    }
    
    .resume-item-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: var(--fs-base);
      margin-bottom: var(--space-xs);
    }
    
    .resume-item-details {
      font-size: var(--fs-sm);
      color: var(--gray-600);
    }
    
    .resume-item-actions {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .selected-indicator {
      width: 2rem;
      height: 2rem;
      border-radius: var(--radius-full);
      background: var(--accent);
      color: var(--white);
      display: none;
      align-items: center;
      justify-content: center;
      font-size: var(--fs-base);
      animation: checkmarkBounce 0.5s ease;
    }
    
    .resume-item.selected .selected-indicator {
      display: flex;
    }
    
    @keyframes checkmarkBounce {
      0% { transform: scale(0); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .btn-select {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: var(--fs-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .btn-select:hover {
      background: var(--primary-dark);
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    .btn-delete {
      background: #dc3545;
      color: var(--white);
      border: none;
      padding: var(--space-sm) var(--space-sm);
      border-radius: var(--radius-md);
      font-size: var(--fs-sm);
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
    }
    
    .btn-delete:hover {
      background: #c82333;
      transform: translateY(-1px);
      box-shadow: var(--shadow-sm);
    }
    
    /* Uploaded File */
    .uploaded-file {
      background: var(--gray-100);
      border: 2px solid var(--accent);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-top: var(--space-lg);
      display: none;
    }
    
    .file-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-lg);
    }
    
    .file-details {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    /* Job Description Textarea */
    .textarea-container {
      margin: var(--space-xl) 0;
    }
    
    .textarea-container label {
      font-size: var(--fs-lg);
      font-weight: 600;
      margin-bottom: var(--space-sm);
      color: var(--gray-900);
      display: block;
    }
    
    .job-description {
      width: 100%;
      min-height: 250px;
      padding: var(--space-lg);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-lg);
      font-size: var(--fs-base);
      font-family: inherit;
      resize: vertical;
      transition: all 0.3s ease;
    }
    
    .job-description:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
    }
    
    .job-description.highlight-flash {
      box-shadow: 0 0 0 4px rgba(0, 102, 204, 0.4);
    }
    
    .page-select {
      margin-top: var(--space-lg);
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }
    
    .page-select label {
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .page-select select {
      padding: var(--space-sm) var(--space-md);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-md);
      font-size: var(--fs-base);
      transition: all 0.3s ease;
    }
    
    .page-select select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Templates Grid */
    .templates-grid {
      display: grid;
      gap: var(--space-lg);
      margin: var(--space-xl) 0;
    }
    
    @media (min-width: 768px) {
      .templates-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    @media (min-width: 1024px) {
      .templates-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .template-card {
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--white);
    }
    
    .template-card:hover {
      border-color: var(--primary);
      transform: translateY(-5px);
      box-shadow: var(--shadow-lg);
    }
    
    .template-card.selected {
      border-color: var(--primary);
      background: rgba(0, 102, 204, 0.05);
      box-shadow: var(--shadow-lg);
    }
    
    .template-logo {
      width: 80px;
      height: 80px;
      object-fit: contain;
      border-radius: var(--radius-lg);
      margin: 0 auto var(--space-lg);
      box-shadow: var(--shadow-md);
      transition: all 0.3s ease;
    }
    
    .template-card:hover .template-logo {
      transform: scale(1.05);
      box-shadow: var(--shadow-lg);
    }
    
    .template-name {
      font-size: var(--fs-xl);
      font-weight: 700;
      margin-bottom: var(--space-sm);
      color: var(--gray-900);
    }
    
    .template-description {
      color: var(--gray-600);
      font-size: var(--fs-sm);
      line-height: 1.5;
    }
    
    /* Loading Section */
    .loading {
      text-align: center;
      padding: var(--space-3xl);
      display: none;
    }
    
    .spinner {
      border: 4px solid var(--gray-200);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
      margin: 0 auto var(--space-lg);
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .progress-container {
      margin: var(--space-xl) 0;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--gray-200);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%);
      width: 0;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      text-align: center;
      margin-top: var(--space-md);
      font-weight: 600;
      color: var(--gray-700);
    }
    
    /* Score Boxes */
    .scores-container {
      display: grid;
      gap: var(--space-lg);
      margin-bottom: var(--space-xl);
    }
    
    @media (min-width: 768px) {
      .scores-container {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .score-box {
      padding: var(--space-xl);
      border-radius: var(--radius-xl);
      text-align: center;
      color: var(--white);
      position: relative;
      overflow: hidden;
    }
    
    .score-box.ats {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    }
    
    .score-box.job {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    }
    
    .score-number {
      font-size: var(--fs-5xl);
      font-weight: 800;
      margin-bottom: var(--space-sm);
    }
    
    .score-label {
      font-size: var(--fs-xl);
      opacity: 0.9;
    }
    
    /* Resume Preview */
    .resume-preview {
      background: var(--white);
      border: 2px solid var(--gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      max-height: 600px;
      overflow-y: auto;
      box-shadow: var(--shadow-md);
    }
    
    /* Navigation Buttons */
    .navigation {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-xl);
      gap: var(--space-lg);
    }
    
    @media (max-width: 640px) {
      .navigation {
        flex-direction: column;
      }
    }
    
    /* Buttons */
    .btn {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: var(--space-md) var(--space-xl);
      border-radius: var(--radius-lg);
      font-size: var(--fs-base);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }
    
    .btn:disabled {
      background: var(--gray-300);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      color: var(--gray-500);
    }
    
    .btn-secondary {
      background: var(--gray-200);
      color: var(--gray-900);
    }
    
    .btn-secondary:hover {
      background: var(--gray-300);
    }
    
    /* Action Buttons */
    .action-buttons {
      display: flex;
      gap: var(--space-md);
      justify-content: center;
      margin-top: var(--space-xl);
      flex-wrap: wrap;
    }
    
    /* Messages */
    .error, .success {
      padding: var(--space-md);
      border-radius: var(--radius-lg);
      margin: var(--space-lg) 0;
      display: none;
      font-weight: 600;
    }
    
    .error {
      background: #dc3545;
      color: var(--white);
    }
    
    .success {
      background: var(--accent);
      color: var(--white);
    }
    
    /* Delete Modal */
    .delete-confirmation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: var(--z-modal);
      padding: var(--space-lg);
    }
    
    .delete-modal {
      background: var(--white);
      padding: var(--space-xl);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-2xl);
      max-width: 400px;
      width: 100%;
      text-align: center;
    }
    
    .delete-modal h3 {
      color: var(--gray-900);
      margin-bottom: var(--space-md);
      font-size: var(--fs-xl);
    }
    
    .delete-modal p {
      color: var(--gray-600);
      margin-bottom: var(--space-xl);
      line-height: 1.5;
    }
    
    .delete-modal-actions {
      display: flex;
      gap: var(--space-md);
      justify-content: center;
    }
    
    .btn-cancel {
      background: var(--gray-500);
      color: var(--white);
      border: none;
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .btn-cancel:hover {
      background: var(--gray-600);
    }
    
    .btn-confirm-delete {
      background: #dc3545;
      color: var(--white);
      border: none;
      padding: var(--space-sm) var(--space-lg);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }
    
    .btn-confirm-delete:hover {
      background: #c82333;
    }
    
    /* Focus States */
    :focus {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }
    
    :focus:not(:focus-visible) {
      outline: none;
    }
    
    /* Selection */
    ::selection {
      background: var(--primary);
      color: var(--white);
    }
    
    @media (max-width: 768px) {
      .main-content-card {
        padding: var(--space-lg);
      }
      
      .step-premium-banner {
        flex-direction: column;
        text-align: center;
      }
      
      .premium-banner-icon {
        font-size: var(--fs-2xl);
      }
      
      .welcome-banner {
        padding: var(--space-lg);
      }
      
      .quick-actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <div class="nav-placeholder" id="navbar">
    {% include 'components/navigation.html' %}
  </div>

  <!-- WhatsApp Float Button -->
  <a href="https://wa.me/916303858671?text=Hi! I'm interested in your job application service." 
     class="whatsapp-float" 
     target="_blank" 
     rel="noopener noreferrer">
    <i class="fab fa-whatsapp"></i>
  </a>

  <div class="container">
    <div class="main-content">
      <!-- Welcome Banner for logged-in users -->
      <div class="welcome-banner">
        <div class="welcome-content">
          <h2>Welcome back, {{ user.username }}! 🎯</h2>
          <p>Ready to create an ATS-optimized resume that gets you interviews? Let's make your career goals a reality.</p>
          <div class="quick-actions">
            <a href="{% url 'ats_details' %}" class="quick-action-btn">
              <i class="fas fa-robot"></i> Learn About ATS
            </a>
            <a href="{% url 'our_services' %}" class="quick-action-btn">
              <i class="fas fa-star"></i> View All Services
            </a>
            <a href="https://wa.me/916303858671?text=Hi! I'm interested in your premium job application service." 
               class="quick-action-btn" target="_blank">
              <i class="fab fa-whatsapp"></i> Get Premium Service
            </a>
          </div>
        </div>
      </div>

      <header class="header">
        <h1><i class="fas fa-file-alt"></i> ATS Resume Optimizer</h1>
        <p>Transform your resume so it perfectly matches any job description.</p>
      </header>

      <main class="main-content-card">
        <!-- STEPPER -->
        <nav class="step-indicator">
          <div class="step-dot active" data-step="1">1</div>
          <div class="step-dot" data-step="2">2</div>
          <div class="step-dot" data-step="3">3</div>
          <div class="step-dot" data-step="4">4</div>
        </nav>

        <div id="errorMessage" class="error"></div>
        <div id="successMessage" class="success"></div>

        <!-- STEP 1 -->
        <section class="step active" id="step1">
          <div class="step-header">
            <div class="step-number">1</div>
            <h2 class="step-title">Upload or Create a Resume</h2>
          </div>

          <!-- Premium Banner for Step 1 -->
          <div class="step-premium-banner">
            <i class="fas fa-crown premium-banner-icon"></i>
            <div class="premium-banner-content">
              <h3>Skip the hassle! Let us handle everything</h3>
              <p>Why spend hours optimizing resumes when our experts can apply to 50+ jobs daily for you?</p>
              <div class="premium-banner-timer">
                <i class="fas fa-clock"></i>
                <span>🎯 4 Days FREE Trial - Offer ends soon!</span>
              </div>
              <a href="https://wa.me/916303858671?text=Hi! I want to try the 4-day free trial for job applications." 
                 class="btn-premium" target="_blank">
                <i class="fab fa-whatsapp"></i> Try Premium Service Free
              </a>
            </div>
          </div>

          <!-- Entry Options -->
          <div class="entry-options">
            <div class="entry-option">
              <div class="upload-area" id="uploadArea">
                <i class="fas fa-cloud-upload-alt upload-icon"></i>
                <p class="upload-text"><strong>Upload Existing Resume</strong></p>
                <p style="color: var(--gray-600); margin-top: var(--space-sm);">PDF, DOC, DOCX (max 10 MB)</p>
                <input type="file" class="file-input" id="fileInput" accept=".pdf,.doc,.docx">
              </div>
            </div>
            
            <div class="entry-option">
              <div class="manual-entry-card" onclick="goToManualEntry()">
                <i class="fas fa-edit manual-entry-icon"></i>
                <div class="manual-entry-title">Enter Details Manually</div>
                <div class="manual-entry-description">
                  Create your resume from scratch using our guided form with all the essential sections
                </div>
              </div>
            </div>
          </div>

          <div class="resume-list-header">
            <i class="fas fa-history" style="color: var(--primary);"></i>
            <h3>Previously uploaded resumes</h3>
          </div>
          <div id="resumeList"></div>
          
          <div class="uploaded-file" id="uploadedFile">
            <div class="file-info">
              <div class="file-details">
                <i class="fas fa-file-alt file-icon"></i>
                <div>
                  <div id="fileName" style="font-weight: 600; color: var(--gray-900);"></div>
                  <div id="fileSize" style="color: var(--gray-600); font-size: var(--fs-sm);"></div>
                </div>
              </div>
              <button class="btn btn-secondary" onclick="removeFile()">
                <i class="fas fa-trash"></i> Remove
              </button>
            </div>
          </div>
          
          <div class="navigation">
            <div></div>
            <button id="nextStep1" class="btn" onclick="nextStep()" disabled>
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </section>

        <!-- STEP 2 -->
        <section class="step" id="step2">
          <div class="step-header">
            <div class="step-number">2</div>
            <h2 class="step-title">Paste Job Description & Select Pages</h2>
          </div>

          <!-- Premium Banner for Step 2 -->
          <div class="step-premium-banner">
            <i class="fas fa-rocket premium-banner-icon"></i>
            <div class="premium-banner-content">
              <h3>We apply to jobs that match YOUR skills</h3>
              <p>Our experts analyze hundreds of job descriptions daily and apply only to positions that fit your profile perfectly.</p>
              <div class="premium-banner-timer">
                <i class="fas fa-clock"></i>
                <span>🎯 Save 40+ hours per week!</span>
              </div>
              <a href="https://wa.me/916303858671?text=Hi! Tell me more about how you match jobs to my profile." 
                 class="btn-premium" target="_blank">
                <i class="fab fa-whatsapp"></i> Get Expert Help
              </a>
            </div>
          </div>

          <div class="textarea-container">
            <label for="jobDescription">Full job description:</label>
            <textarea id="jobDescription" class="job-description"
              placeholder="Include responsibilities, must-have skills, qualifications…"></textarea>
          </div>
          <div class="page-select">
            <label for="numPages">Desired resume length:</label>
            <select id="numPages">
              <option value="1">1 page</option>
              <option value="2" selected>2 pages</option>
              <option value="3">3 pages</option>
            </select>
          </div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button id="nextStep2" class="btn" onclick="nextStep()" disabled>
              Next <i class="fas fa-arrow-right"></i>
            </button>
          </div>
        </section>

        <!-- STEP 3 -->
        <section class="step" id="step3">
          <div class="step-header">
            <div class="step-number">3</div>
            <h2 class="step-title">Choose a Template</h2>
          </div>

          <!-- Premium Banner for Step 3 -->
          <div class="step-premium-banner">
            <i class="fas fa-trophy premium-banner-icon"></i>
            <div class="premium-banner-content">
              <h3>Get interviews, not just resumes!</h3>
              <p>While you pick templates, we could be sending out 50+ applications with personalized cover letters.</p>
              <div class="premium-banner-timer">
                <i class="fas fa-clock"></i>
                <span>🎯 15 days average to first interview!</span>
              </div>
              <a href="https://wa.me/916303858671?text=Hi! I want faster results with your premium service." 
                 class="btn-premium" target="_blank">
                <i class="fab fa-whatsapp"></i> Skip to Interviews
              </a>
            </div>
          </div>

          <div id="templatesGrid" class="templates-grid"></div>
          <div class="navigation">
            <button class="btn btn-secondary" onclick="prevStep()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
            <button id="nextStep3" class="btn" onclick="generateResume()" disabled>
              Generate Resume <i class="fas fa-magic"></i>
            </button>
          </div>
        </section>

        <!-- STEP 4 -->
        <section class="step" id="step4">
          <div class="step-header">
            <div class="step-number">4</div>
            <h2 class="step-title">Preview & Download</h2>
          </div>

          <!-- Premium Banner for Step 4 -->
          <div class="step-premium-banner">
            <i class="fas fa-star premium-banner-icon"></i>
            <div class="premium-banner-content">
              <h3>Great resume! Now what?</h3>
              <p>You've got the resume, but applying to hundreds of jobs is exhausting. Let our experts take over!</p>
              <div class="premium-banner-timer">
                <i class="fas fa-clock"></i>
                <span>🎯 Join professionals who found jobs in 15 days!</span>
              </div>
              <a href="https://wa.me/916303858671?text=Hi! I have my resume ready. Help me with job applications." 
                 class="btn-premium" target="_blank">
                <i class="fab fa-whatsapp"></i> Let Us Apply For You
              </a>
            </div>
          </div>

          <div id="loadingSection" class="loading">
            <div class="spinner"></div>
            <div class="progress-container">
              <div class="progress-bar">
                <div id="progressFill" class="progress-fill"></div>
              </div>
              <div id="progressText" class="progress-text">Analyzing your resume…</div>
            </div>
          </div>
          <div id="resultContainer" style="display:none">
            <div class="scores-container">
              <div class="score-box ats">
                <div id="atsScore" class="score-number">0</div>
                <div class="score-label">ATS Compatibility</div>
              </div>
              <div class="score-box job">
                <div id="jobScore" class="score-number">0</div>
                <div class="score-label">Job Match Score</div>
              </div>
            </div>
            <div id="resumePreview" class="resume-preview"></div>
            <div class="action-buttons">
              <button class="btn" onclick="downloadPDF()">
                <i class="fas fa-download"></i> Download PDF
              </button>
              <button class="btn btn-secondary" onclick="startOver()">
                <i class="fas fa-redo"></i> Start over
              </button>
              <button class="btn btn-secondary" onclick="prevStep()">
                <i class="fas fa-arrow-left"></i> Back to templates
              </button>
              <button class="btn btn-secondary" onclick="scrollToJobDescription()">
                <i class="fas fa-pen"></i> Try Another Job Description
              </button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="delete-confirmation" id="deleteConfirmation">
    <div class="delete-modal">
      <h3><i class="fas fa-exclamation-triangle" style="color:#dc3545;margin-right:10px"></i>Confirm Delete</h3>
      <p>Are you sure you want to delete this resume? This action cannot be undone.</p>
      <div class="delete-modal-actions">
        <button class="btn-cancel" onclick="cancelDelete()">
          <i class="fas fa-times"></i> Cancel
        </button>
        <button class="btn-confirm-delete" onclick="confirmDelete()">
          <i class="fas fa-trash"></i> Delete
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPT - Keeping all original functionality -->
  <script>
    function scrollToJobDescription() {
      const jd = document.getElementById('jobDescription');
      if (jd) {
        goToStep(2);  // Reuse your existing function
        setTimeout(() => {
          jd.scrollIntoView({ behavior: 'smooth', block: 'center' });
          jd.focus({ preventScroll: true });
          jd.classList.add('highlight-flash');
          setTimeout(() => jd.classList.remove('highlight-flash'), 1000);
        }, 300);
      }
    }

    /* CONFIG */
    let currentStep=1, currentResumeID=null, selectedTemplate=null;
    let deleteResumeId = null; // For tracking which resume to delete
    const csrftoken='{{ csrf_token }}';

    /* INIT */
    document.addEventListener('DOMContentLoaded',()=>{
      hookStepper();
      loadPrevResumes();
      loadTemplates();
      setupUpload();
      document.getElementById('jobDescription').addEventListener('input',()=>validateNext());
    });

    /* MANUAL ENTRY */
    function goToManualEntry() {
      window.location.href = '/manual-resume/create/';
    }

    /* STEPPER */
    function goToStep(n){
      document.querySelectorAll('.step').forEach(s=>s.classList.toggle('active',s.id==='step'+n));
      document.querySelectorAll('.step-dot').forEach(d=>{
        const idx=+d.dataset.step;
        d.classList.remove('active','completed');
        if(idx===n)d.classList.add('active');
        else if(idx<n)d.classList.add('completed');
      });
      currentStep=n;
    }
    function nextStep(){ if(currentStep<4) goToStep(currentStep+1) }
    function prevStep(){ if(currentStep>1) goToStep(currentStep-1) }
    function hookStepper(){
      document.querySelectorAll('.step-dot').forEach(d=>
        d.addEventListener('click',()=>goToStep(+d.dataset.step))
      );
    }

    /* UPLOAD */
    function setupUpload(){
      const area=document.getElementById('uploadArea');
      const input=document.getElementById('fileInput');
      area.addEventListener('click',()=>input.click());
      input.addEventListener('change',e=>handleFile(e.target.files[0]));
      ['dragover','dragleave','drop'].forEach(ev=>
        area.addEventListener(ev,e=>{ e.preventDefault(); })
      );
      area.addEventListener('dragover',()=>area.classList.add('dragover'));
      area.addEventListener('dragleave',()=>area.classList.remove('dragover'));
      area.addEventListener('drop',e=>{
        area.classList.remove('dragover');
        handleFile(e.dataTransfer.files[0]);
      });
    }
    async function handleFile(file){
      if(!file) return;
      const ext='.'+file.name.split('.').pop().toLowerCase();
      if(!['.pdf','.doc','.docx'].includes(ext)) return showError('Please upload PDF/DOC/DOCX');
      if(file.size>10*1024*1024) return showError('File must be under 10 MB');
      const fd=new FormData(); fd.append('file',file);
      showSuccess('Uploading resume…');
      const res=await fetch('/api/upload/',{ method:'POST', body:fd, headers:{'X-CSRFToken':csrftoken} });
      const data=await res.json();
      if(!res.ok) return showError(data.error||'Upload failed');
      currentResumeID=data.resume_id;
      document.getElementById('fileName').textContent=file.name;
      document.getElementById('fileSize').textContent=(file.size/1024/1024).toFixed(1)+' MB';
      document.getElementById('uploadedFile').style.display='block';
      document.getElementById('nextStep1').disabled=false;
      showSuccess('Upload complete!');
      loadPrevResumes(); // Refresh the list
    }
    function removeFile(){
      currentResumeID=null;
      document.getElementById('uploadedFile').style.display='none';
      document.getElementById('fileInput').value='';
      document.getElementById('nextStep1').disabled=true;
      
      // Clear selection from resume list
      document.querySelectorAll('.resume-item').forEach(item => {
        item.classList.remove('selected');
      });
    }

    /* PREVIOUS RESUMES WITH ENHANCED UI */
    async function loadPrevResumes(){
      const container=document.getElementById('resumeList');
      container.innerHTML='<div style="color:var(--primary);padding:20px;text-align:center"><i class="fas fa-spinner fa-spin"></i> Loading resumes...</div>';
      try {
        const res=await fetch('/api/resumes/');
        const data=await res.json();
        container.innerHTML='';
        
        if(!data.resumes.length){
          container.innerHTML=`
            <div style="color:var(--gray-600);padding:30px;text-align:center;border:2px dashed var(--gray-300);border-radius:var(--radius-lg);background:var(--gray-100)">
              <i class="fas fa-folder-open" style="font-size:2rem;margin-bottom:15px;opacity:0.7"></i>
              <p style="margin:0;font-size:1.1rem">No previous resumes found</p>
              <p style="margin:5px 0 0;font-size:0.9rem;opacity:0.8">Upload your first resume or create one manually</p>
            </div>`;
          return;
        }
        
        data.resumes.forEach(r=>{
          const item = document.createElement('div');
          item.className = 'resume-item';
          item.dataset.resumeId = r.id;
          
          item.innerHTML = `
            <div class="resume-item-left">
              <i class="fas fa-file-alt file-icon"></i>
              <div class="resume-item-info">
                <div class="resume-item-name">${r.filename}</div>
                <div class="resume-item-details">
                  Uploaded ${new Date(r.created_at).toLocaleDateString()} • ${r.file_size}
                </div>
              </div>
            </div>
            <div class="resume-item-actions">
              <div class="selected-indicator">
                <i class="fas fa-check"></i>
              </div>
              <button class="btn-select" onclick="selectResume(${r.id}, this)">
                <i class="fas fa-mouse-pointer"></i> Select
              </button>
              <button class="btn-delete" onclick="deleteResume(${r.id})" title="Delete Resume">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          `;
          
          container.appendChild(item);
        });
      } catch {
        container.innerHTML=`
          <div style="color:#dc3545;padding:20px;text-align:center;border:2px solid #dc3545;border-radius:var(--radius-lg);background:#f8f9fa">
            <i class="fas fa-exclamation-triangle" style="font-size:1.5rem;margin-bottom:10px"></i>
            <p style="margin:0">Failed to load resume list</p>
          </div>`;
      }
    }

    /* RESUME SELECTION WITH GREEN TICK */
    function selectResume(resumeId, buttonElement) {
      // Clear all previous selections
      document.querySelectorAll('.resume-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // Select the current item
      const resumeItem = buttonElement.closest('.resume-item');
      resumeItem.classList.add('selected');
      
      // Update current resume ID
      currentResumeID = resumeId;
      
      // Enable next step
      document.getElementById('nextStep1').disabled = false;
      
      // Hide uploaded file section if showing
      document.getElementById('uploadedFile').style.display = 'none';
      
      showSuccess('Resume selected! You can now proceed to the next step.');
    }

    /* RESUME DELETION */
    function deleteResume(resumeId) {
      deleteResumeId = resumeId;
      document.getElementById('deleteConfirmation').style.display = 'flex';
    }

    function cancelDelete() {
      deleteResumeId = null;
      document.getElementById('deleteConfirmation').style.display = 'none';
    }

    async function confirmDelete() {
      if (!deleteResumeId) return;
      
      try {
        const res = await fetch(`/api/resumes/${deleteResumeId}/`, {
          method: 'DELETE',
          headers: {'X-CSRFToken': csrftoken}
        });
        
        if (res.ok) {
          showSuccess('Resume deleted successfully!');
          
          // If this was the selected resume, clear selection
          if (currentResumeID === deleteResumeId) {
            currentResumeID = null;
            document.getElementById('nextStep1').disabled = true;
          }
          
          // Reload the resume list
          loadPrevResumes();
        } else {
          const data = await res.json();
          showError(data.error || 'Failed to delete resume');
        }
      } catch (error) {
        showError('Failed to delete resume. Please try again.');
      }
      
      // Close modal
      cancelDelete();
    }

    /* JOB DESCRIPTION VALIDATION */
    function validateNext(){
      const ok=document.getElementById('jobDescription').value.trim().length>50;
      document.getElementById('nextStep2').disabled=!ok;
    }

    /* TEMPLATE LIST */
    /* TEMPLATE LIST — shows the real PNG logos */
    async function loadTemplates () {
      const grid = document.getElementById('templatesGrid');
      grid.innerHTML = '<p style="color:var(--primary);text-align:center;">Loading templates…</p>';

      try {
        const res  = await fetch('/templates/');
        const data = await res.json();
        grid.innerHTML = '';

        data.templates.forEach(t => {
          /* 1. Build the card wrapper */
          const card = document.createElement('div');
          card.className  = 'template-card';
          card.dataset.id = t.id;

          /* 2. Build the logo URL — API gives "static/resume/logos/Harvard.png" */
          const logoUrl = t.logo.startsWith('/') ? t.logo : '/' + t.logo;

          /* 3. Inject markup */
          card.innerHTML = `
            <img src="${logoUrl}" alt="${t.name} logo" class="template-logo">
            <div class="template-name">${t.name}</div>
            <div class="template-description">${t.description || ''}</div>
          `;

          /* 4. Click handler */
          card.onclick = () => {
            document.querySelectorAll('.template-card')
                    .forEach(c => c.classList.remove('selected'));
            card.classList.add('selected');
            selectedTemplate = t.id;
            document.getElementById('nextStep3').disabled = false;
          };

          grid.appendChild(card);
        });
      } catch {
        grid.innerHTML =
          '<p style="color:var(--gray-900);text-align:center;">Failed to load templates</p>';
      }
    }


    /* GENERATE RESUME WITH REAL-TIME PROGRESS */
    async function generateResume(){
      if(!currentResumeID||!selectedTemplate) return;
      
      nextStep();
      document.getElementById('loadingSection').style.display='block';
      document.getElementById('resultContainer').style.display='none';
      
      // Reset progress
      document.getElementById('progressFill').style.width = '0%';
      document.getElementById('progressText').textContent = 'Starting resume generation...';

      const payload={
        job_description:document.getElementById('jobDescription').value,
        num_pages:+document.getElementById('numPages').value
      };
      
      try {
        // Start generation
        const res = await fetch(`/api/generate/${currentResumeID}/${selectedTemplate}/`,{
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          body:JSON.stringify(payload)
        });
        
        const data = await res.json();
        if(!res.ok) throw new Error(data.error||'Generation failed');
        
        if(data.task_id) {
          // Start polling for progress
          pollProgress(data.task_id);
        } else {
          // Fallback to old method
          handleGenerationComplete(data);
        }
        
      } catch(err){
        showError(err.message||'Failed to generate');
        prevStep();
      }
    }

    async function pollProgress(taskId) {
      const pollInterval = 1000; // Poll every second
      const maxPolls = 120; // Max 2 minutes
      let pollCount = 0;
      
      const poll = async () => {
        try {
          const res = await fetch(`/api/progress/${taskId}/`);
          const progress = await res.json();
          
          if (!res.ok) {
            throw new Error(progress.error || 'Progress check failed');
          }
          
          // Update progress bar
          document.getElementById('progressFill').style.width = `${progress.progress}%`;
          document.getElementById('progressText').textContent = progress.message;
          
          if (progress.completed) {
            if (progress.error) {
              throw new Error(progress.error);
            } else if (progress.result) {
              handleGenerationComplete(progress.result);
            }
            return;
          }
          
          // Continue polling if not completed
          pollCount++;
          if (pollCount < maxPolls) {
            setTimeout(poll, pollInterval);
          } else {
            throw new Error('Generation timeout - please try again');
          }
          
        } catch (error) {
          showError(error.message || 'Progress check failed');
          prevStep();
        }
      };
      
      // Start polling
      poll();
    }

    function handleGenerationComplete(data) {
      // Update scores and preview
      document.getElementById('atsScore').textContent = data.ats_score + '%';
      document.getElementById('jobScore').textContent = data.job_score + '%';
      document.getElementById('resumePreview').innerHTML = data.final_resume;
      
      // Show success animation
      document.getElementById('progressFill').style.width = '100%';
      document.getElementById('progressText').textContent = 'Resume generated successfully!';
      
      // Hide loading and show results after brief delay
      setTimeout(() => {
        document.getElementById('loadingSection').style.display = 'none';
        document.getElementById('resultContainer').style.display = 'block';
        
        // Add success animation to scores
        const scoreBoxes = document.querySelectorAll('.score-box');
        scoreBoxes.forEach((box, index) => {
          setTimeout(() => {
            box.style.animation = 'scoreReveal 0.6s ease-out forwards';
            box.style.transform = 'scale(1.05)';
            setTimeout(() => {
              box.style.transform = 'scale(1)';
            }, 600);
          }, index * 200);
        });
      }, 800);
    }

    /* DOWNLOAD PDF */
    async function downloadPDF () {
      if (!currentResumeID) return;

      try {
        const res = await fetch(`/api/download/${currentResumeID}/`);

        /* ----- 1. Handle non-200 responses ----- */
        if (!res.ok) {
          // Try to parse the JSON error payload; fallback to plain-text
          let payload = {};
          try { payload = await res.json(); } catch (_) { /* ignore */ }

          // 429 from our quota guard
          if (payload.contact_url) {
            return Swal.fire({
              icon: 'warning',
              title: 'Download limit reached',
              text: payload.message || 'You have crossed your free limit.',
              confirmButtonText: 'Contact on WhatsApp',
              confirmButtonColor: '#25D366'
            }).then(() => window.open(payload.contact_url, '_blank'));
          }

          // Any other error → generic handler
          return showError(payload.error || 'Download failed');
        }

        /* ----- 2. Success: stream the PDF to the user ----- */
        const contentDisp = res.headers.get('Content-Disposition') || '';
        const match      = contentDisp.match(/filename="?([^"]+)"?/i);
        const filename   = match ? match[1] : 'resume.pdf';

        const blob = await res.blob();
        const url  = URL.createObjectURL(blob);

        const a    = document.createElement('a');
        a.href     = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      }
      catch (err) {
        console.error(err);
        showError('Network error while downloading PDF');
      }
    }

    /* UTILS */
    function startOver(){ location.reload(); }
    function showError(msg){
      const e=document.getElementById('errorMessage');
      e.textContent=msg; e.style.display='block';
      setTimeout(()=>e.style.display='none',5000);
    }
    function showSuccess(msg){
      const e=document.getElementById('successMessage');
      e.textContent=msg; e.style.display='block';
      setTimeout(()=>e.style.display='none',3000);
    }
  </script>
</body>
</html>